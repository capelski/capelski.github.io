<!DOCTYPE html><html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="Carles Capellas"><meta name="theme-color" content="#000000"><meta name="robots" content="index, follow"><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js",{scope:"/"})}))</script><link rel="manifest" href="/manifest.json"><link rel="icon" type="image/png" href="/favicon.png"><script defer="defer" src="/main.js"></script><link href="/main.css" rel="stylesheet"><title>React server side rendering powered by Webpack | Carles Capellas</title><meta name="description" content="How to generate a Node.js compatible webpack bundle to render a React app on the server" data-react-helmet="true"><meta property="og:site_name" content="Carles Capellas" data-react-helmet="true"><meta property="og:type" content="article" data-react-helmet="true"><meta property="og:title" content="React server side rendering powered by Webpack" data-react-helmet="true"><meta property="og:description" content="How to generate a Node.js compatible webpack bundle to render a React app on the server" data-react-helmet="true"><meta property="og:url" content="https://capelski.github.io/blog/react-ssr" data-react-helmet="true"><meta property="og:image" content="https://capelski.github.io/images/blog/react-ssr/server-rendering.jpg" data-react-helmet="true"></head><body><noscript><h1>Carles Capellas</h1><p>JavaScript is required to load my page</p></noscript><div id="app-placeholder"><div class="app-container"><div class="article-container"><div class="section-viewport"><div class="section-content"><div class="article react-ssr" lang="en"><div class="article-info"><h2 class="article-title">React server side rendering powered by Webpack</h2><div class="article-details"><span class="article-date">ğŸ“… 2025-03-18</span><span class="article-duration">ğŸ• 7 mins</span><span class="article-language selected-language">ğŸŒ en</span></div></div><div class="article-body"><p>Sooner or later you will need to support Search Engine Optimization in your React app. Fortunately, React uses a virtual DOM and it can easily be rendered on Node.js servers. We just need to generate a Node.js compatible assets bundle, make the server aware of the client side routing and adapt asynchronous data fetching. Let's get started.</p><div><img class="article-image image-600" src="/images/blog/react-ssr/server-rendering.jpg" alt="Abstract representation of server rendering"></div><h3>Starting point</h3><p>We will start with the simplest Typescript stack possible: an express server that serves static files and a "Hello World" React app. We will later be adding client routing and asynchronous data fetching but let's set the basics straight first. Here is the repository structure (more on <a href="https://github.com/capelski/react-ssr/tree/starting-point" target="_blank">this git branch</a>).</p><div class="article-block-snippet">repository<br>ğŸ“‚&nbsp;client<br>|&nbsp;&nbsp;ğŸ“‚&nbsp;source<br>|&nbsp;&nbsp;|&nbsp;&nbsp;ğŸ“&nbsp;app.tsx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# React app<br>|&nbsp;&nbsp;|&nbsp;&nbsp;ğŸ“&nbsp;index.html<br>|&nbsp;&nbsp;|&nbsp;&nbsp;ğŸ“&nbsp;index.tsx&nbsp;&nbsp;&nbsp;&nbsp;# Webpack entry point<br>|&nbsp;&nbsp;ğŸ“‚&nbsp;webpack<br>|&nbsp;&nbsp;ğŸ“&nbsp;package.json<br>|&nbsp;&nbsp;ğŸ“&nbsp;tsconfig.json<br>ğŸ“‚&nbsp;server<br>&nbsp;&nbsp;&nbsp;ğŸ“‚&nbsp;source<br>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;ğŸ“&nbsp;server.ts&nbsp;&nbsp;&nbsp;&nbsp;# express static server<br>&nbsp;&nbsp;&nbsp;ğŸ“‚&nbsp;static<br>&nbsp;&nbsp;&nbsp;ğŸ“&nbsp;package.json<br>&nbsp;&nbsp;&nbsp;ğŸ“&nbsp;tsconfig.json<br></div><iframe width="100%" frameborder="0" id="gist-12f99ea748aeadf5224ac92635bc62a1"></iframe><iframe width="100%" frameborder="0" id="gist-3181f618e32032e294af6c1d3d01b421"></iframe><p>As per usual, the server returns the static HTML file and the application renders the app on the client side. Let's get the server rendering ğŸ› ï¸</p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/static-html.png" alt="Static HTML sent by the server"><p class="article-image-footer">Static HTML sent by the server</p></div><h3>Server SSR setup</h3><p>First things first: the server can no longer return the static files straightaway. We will need to intercept requests to the index.html file, render the React app on the server (via the <span class="article-inline-snippet">renderToString</span> function from <span class="article-inline-snippet">react-dom/server</span>) and return the corresponding HTML to the client. There are a few things we need to pay attention to:</p><iframe width="100%" frameborder="0" id="gist-c796bbff8774fe445bf8c19a61ca8a0b"></iframe><ul><li><span class="article-inline-snippet">react</span> and <span class="article-inline-snippet">react-dom</span> become dependencies of the server app. We will need to install them so Node.js can import them via require.<div class="article-block-snippet">npm i -S react react-dom<br>npm i -D @types/react @types/react-dom</div></li><li>We need to import the React app from a Node.js compatible bundle. This bundle will be generated from the client project with different Webpack configuration and it needs to be available to the server. In this example, it will be located in a <span class="article-inline-snippet">ssr</span> directory (i.e. <span class="article-inline-snippet">require('../ssr/app.js')</span>).</li><li>The <span class="article-inline-snippet">renderToString</span> function expects a React node, not a React component. We need to wrap the function component in a <span class="article-inline-snippet">React.createElement</span> call.</li><li>The <span class="article-inline-snippet">renderToString</span> function produces the following HTML, but we need to send a full HTML document to the client. Note that we also need that document to load the client Javascript bundle. A simple way of creating the HTML document is by reading the static file we were previously serving and appending the server rendered HTML into the <span class="article-inline-snippet">app-placeholder</span> element.<div class="article-block-snippet">&lt;h1&gt;Hello World!&lt;/h1&gt;</div></li></ul><h3>Webpack SSR setup</h3><p>The main issue with the client Webpack bundle is that it is built to run on a browser. Importing it from the Node.js server will raise all sort of errors. On one hand, the client bundle tries to mount the React app to the browser document. Since in Node.js there is no document we will need to skip the mount.</p><p>For that we will need a separate webpack file that specifies <span class="article-inline-snippet">app.tsx</span> as the entry point and extracts the output to some directory in the server project (in this example, I'm calling the directory <span class="article-inline-snippet">ssr</span>). We will also add an npm script to package.json to build the Node.js bundle (i.e. <span class="article-inline-snippet">build:ssr</span>).</p><div class="article-block-snippet">"build:ssr": "rm -rf ../server/ssr &amp;&amp; webpack --config webpack/ssr.config.js",</div><p>On the other hand, webpack replaces the export statements and includes the client side dependencies. We need to keep the exports so Node.js can require the React app. And, if some of our dependencies relay on running in the browser, they might raise exceptions when required from the server side. Let's add a couple tweaks to the SSR webpack configuration.</p><iframe width="100%" frameborder="0" id="gist-eb61d26dc971f8035a005b3e488078d0"></iframe><ul><li><p><b>output.libraryTarget / target</b>. Setting this properties to <span class="article-inline-snippet">umd</span> and <span class="article-inline-snippet">node</span> will make the bundle exports compatible with Node.js.</p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/node-targeted-bundle-diff.png" alt="Change in the webpack generated bundle"><p class="article-image-footer">Change in the webpack generated bundle</p></div></li><li><p><b>externals</b>. <a href="https://webpack.js.org/configuration/externals/" target="_blank">this configuration option</a> provides a way of excluding dependencies from the output bundles, assuming they will be made available by the consumer of the bundle instead. Used along with <a href="https://www.npmjs.com/package/webpack-node-externals" target="_blank">webpack-node-externals</a> it will exclude all modules from the <span class="article-inline-snippet">node_modules</span> directory.</p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/webpack-default-build.png" alt="Size of the client webpack bundle"><p class="article-image-footer">Size of the client webpack bundle</p></div><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/webpack-node-build.png" alt="Size of the Node.js webpack bundle"><p class="article-image-footer">Size of the Node.js webpack bundle</p></div></li></ul><p>The generated bundle is now compatible with Node.js, so it can be rendered on the server side ğŸ‰ See <a href="https://github.com/capelski/react-ssr/compare/starting-point...basic-ssr" target="_blank">this change set</a> for more details.</p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/server-rendered-html.png" alt="HTML rendered by the server"><p class="article-image-footer">HTML rendered by the server</p></div><h3>Routing</h3><p>Most modern apps use client side routing. Let's make our React app a bit more relevant by adding <span class="article-inline-snippet">react-router</span> and a couple of different routes. Note that the <span class="article-inline-snippet">BrowserRouter</span> must be provided in the <span class="article-inline-snippet">index.tsx</span> file; doing so on <span class="article-inline-snippet">app.tsx</span> would cause errors on the server side, as the router references the window document.</p><div class="article-block-snippet">cd client &amp;&amp; npm i -S react-router</div><iframe width="100%" frameborder="0" id="gist-72cc7be9f5179130b5680ec9cd82f6a4"></iframe><p>Now we need to adapt the server rendering to support the in-app routing. We need to install <span class="article-inline-snippet">react-router</span> as a dependency of the server and then render the app within a router component. Because <span class="article-inline-snippet">BrowserRouter</span> is not supported on the server side, we will use <span class="article-inline-snippet">StaticRouter</span> instead. Passing the URL of the http request to the router via the location parameter is enough for it to know which component to render.</p><iframe width="100%" frameborder="0" id="gist-2e7b86df2bb51da25f99488be2f91756"></iframe><p>Lastly we need to modify the express middleware to intercept requests to the new route (i.e. "/login") and render the app at that path. We now support deep links server rendering ğŸ» See <a href="https://github.com/capelski/react-ssr/compare/basic-ssr...routing" target="_blank">this change set</a> for more details .</p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/deep-links-server-rendering.png" alt="HTML rendered by the server at the corresponding route"><p class="article-image-footer">HTML rendered by the server at the corresponding route</p></div><h3>Fetching data on app start</h3><p>Finally let's fetch some data asynchronously during the app initialization. Let's say we want to fetch a list of user names from the server and display them in the home page (simple use case for demonstration purposes). We will add a new endpoint (e.g. <span class="article-inline-snippet">/api/user-names</span>) that retrieves the user names and we will query it during the Home page initialization. In function components this is usually done via <span class="article-inline-snippet">useEffect</span> hooks.</p><iframe width="100%" frameborder="0" id="gist-65ba7f90b2a8b24f749f0b1cb0a3b4c6"></iframe><iframe width="100%" frameborder="0" id="gist-2c3fe8b74db07d93499b95e212113c30"></iframe><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/server-rendered-html-loading.png" alt="List of user names in the client app"><p class="article-image-footer">List of user names in the client app</p></div><p>While the client version works, it turns out the server rendered HTML doesn't contain the list of user names. This happens because React doesn't trigger <span class="article-inline-snippet">useEffect</span> hooks outside of the browser. Since we want the server rendered HTML to include the list of user names, we will need to fetch them outside of the hooks.</p><p>One way to do it is modifying the React app so it can receive the list of user names via props. We can then fetch the list of user names outside of the React lifecycle and render the app once the data is ready, passing the data via props. With this change the resulting server rendered HTML will now contain the list of user names ğŸ‘</p><iframe width="100%" frameborder="0" id="gist-c955c94e24a85eccbff4bc140e7848aa"></iframe><iframe width="100%" frameborder="0" id="gist-1995b1b8c19b2278188025c97904f099"></iframe><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/server-rendered-html-list.png" alt="HTML rendered by the server including the list of user names"><p class="article-image-footer">HTML rendered by the server including the list of user names</p></div><p>Note however that, when running in the browser, the React app doesn't recognize it had already been rendered in the server; it displays the loader and fetches the list of user names again. If we can prevent the redundant fetch request we will consume less resources and will improve the user experience as well.</p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/redundant-fetch-request.png" alt="Redundant fetch request triggered by the client app rendering"><p class="article-image-footer">Redundant fetch request triggered by the client app rendering</p></div><p>Fortunately it is not complicated. We just need to make the initial state we used on the server side available to the client side, and inject them to React when initializing the app. Note that the <span class="article-inline-snippet">useEffect</span> will still run in the browser. We cannot remove it if we want the list to be refreshed upon back and forth navigation, and it is convenient to keep it for development mode as well (the app will not have been rendered in the server). What we can do is preventing the fetch request when we already have a list of user names.</p><iframe width="100%" frameborder="0" id="gist-0bc99e1b52cfd4c8a4cc38d912177742"></iframe><p><i>According to the <a href="https://react.dev/reference/react-dom/client/hydrateRoot#hydrateroot" target="_blank">React docs</a>, the <span class="article-inline-snippet">hydrateRoot</span> function can be used to â€œattach React to existing HTML that was already rendered by React in a server environment". At practice though I couldn't observe any different behavior between <span class="article-inline-snippet">hydrateRoot(container, &lt;AppWithRouter {...initialState} /&gt;)</span> and <span class="article-inline-snippet">createRoot(container).render(&lt;AppWithRouter {...initialState} /&gt;)</span>.</i></p><div><img class="article-image with-footer image-600" src="/images/blog/react-ssr/rehydrated-state.png" alt="Client rendered app without redundant fetch request"><p class="article-image-footer">Client rendered app without redundant fetch request</p></div><p>That's it! React SSR with support for deep links and asynchronous data fetching ğŸ’ƒ See <a href="https://github.com/capelski/react-ssr/compare/routing...data-fetching" target="_blank">this change set</a> for more details and star the <a href="https://github.com/capelski/react-ssr" target="_blank">entire repository</a> for future reference. Happy coding!</p><h3>Troubleshooting</h3><ul><li><p>A dependency of the client bundle has not been installed on the server (e.g. react, react-dom, react-router, etc.).</p><div class="article-block-snippet">Error: Cannot find module 'react'<br>Require stack:<br>â€ƒ- react-ssr/server/source/server.ts</div></li><li><p>The server assets bundle contains references to <span class="article-inline-snippet">document</span> or dependencies that relay on it.</p><div class="article-block-snippet">ReferenceError: document is not defined<br>â€ƒat Object.596 (react-ssr/server/static/main.js:2:139274)<br>â€ƒat t (react-ssr/server/static/main.js:2:139761)<br>â€ƒat react-ssr/server/static/main.js:2:139801<br>â€ƒat Object.&lt;anonymous&gt; (react-ssr/server/static/main.js:2:139808)<br></div></li><li><p>The server assets bundle is not exporting the React app via Node.js exports. Most likely Webpack is not specifying the right target/libraryTarget.</p><div class="article-block-snippet">TypeError: App is not a function<br>â€ƒat react-ssr/server/source/server.ts:11:34<br>â€ƒat Generator.next (&lt;anonymous&gt;)<br>â€ƒat react-ssr/server/source/server.ts:8:71<br></div></li><li><p><span class="article-inline-snippet">renderToString</span> is receiving a React component (i.e. <span class="article-inline-snippet">renderToString(App)</span>) instead of a React node (i.e. <span class="article-inline-snippet">renderToString(createElement(App))</span>).</p><div class="article-block-snippet">Warning: Functions are not valid as a React child. This may happen if you return a Component instead of &lt;Component /&gt; from render. Or maybe you meant to call this function rather than return it.</div></li><li><p>The React app includes a browser based router (e.g. <span class="article-inline-snippet">BrowserRouter</span> or <span class="article-inline-snippet">HashRouter</span>) which ends up in the server assets. The server version must use a compatible version instead (e.g. <span class="article-inline-snippet">StaticRouter</span>).</p><div class="article-block-snippet">react-ssr/server/node_modules/react-router/dist/development/index.js:404<br>let { window: window2 = document.defaultView, v5Compat = false } = options;<br><br>ReferenceError: document is not defined<br>â€ƒat getUrlBasedHistory (react-ssr/server/node_modules/react-router/dist/development/index.js:404:27)</div></li><li><p>The server is not providing a router component when rendering the App.</p><div class="article-block-snippet">react-ssr/server/node_modules/react-router/dist/development/index.js:336<br>throw new Error(message);<br><br>Error: useLocation() may be used only in the context of a &lt;Router&gt; component.<br>â€ƒat invariant (react-ssr/server/node_modules/react-router/dist/development/index.js:336:11)</div></li><li><p>The server is calling the React app function directly (i.e. <span class="article-inline-snippet">renderToString(App)</span>), instead of rendering it within the React lifecycle (i.e. <span class="article-inline-snippet">renderToString(createElement(App))</span>).</p><div class="article-block-snippet">Warning: Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:<br>1. You might have mismatching versions of React and the renderer (such as React DOM)<br>2. You might be breaking the Rules of Hooks<br>3. You might have more than one copy of React in the same app<br>See https://reactjs.org/link/invalid-hook-call for tips about how to debug and fix this problem.<br>react-ssr/server/node_modules/react/cjs/react.development.js:1622<br>return dispatcher.useState(initialState);<br><br>TypeError: Cannot read properties of null (reading 'useState')<br>â€ƒat useState (react-ssr/server/node_modules/react/cjs/react.development.js:1622:21) <br></div></li><li><p>The server assets bundle includes dependencies that are not supported on the server. Most likely Webpack is not specifying the right externals property.</p><div class="article-block-snippet">TypeError: Cannot read properties of null (reading 'useContext')<br>â€ƒat Object.t.useContext (react-ssr/server/ssr/app.js:2:9370)<br>â€ƒat zt (react-ssr/server/ssr/app.js:2:78603)<br>â€ƒat react-ssr/server/ssr/app.js:2:126961<br>â€ƒat renderWithHooks (react-ssr/server/node_modules/react-dom/cjs/react-dom-server-legacy.node.development.js:5662:16)</div></li></ul><h3 class="posts-timeline">Posts timeline</h3><div class="article-links"><div class="previous-link"><span class="link-text"><a href="/blog/jira-google-sheets">â¬…ï¸ Previous</a><div class="title-preview">Supercharged JIRA reporting using Google Sheets</div></span></div><div class="next-link"></div></div></div></div></div></div><div class="section-links"><a aria-current="page" class="link active" href="/blog">â¬‡ï¸ Blog</a></div></div></div></div></body></html>