<!DOCTYPE html><html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="Carles Capellas"><meta name="theme-color" content="#000000"><meta name="robots" content="index, follow"><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js",{scope:"/"})}))</script><link rel="manifest" href="/manifest.json"><link rel="icon" type="image/png" href="/favicon.png"><link href="/main.css" rel="stylesheet"><title>Apple/Google authentication in Expo apps using&nbsp;Firebase | Carles Capellas</title><meta name="description" content="How to implement Apple and Google authentication in Expo apps using Firebase" data-react-helmet="true"><meta property="og:site_name" content="Carles Capellas" data-react-helmet="true"><meta property="og:type" content="article" data-react-helmet="true"><meta property="og:title" content="Apple/Google authentication in Expo apps using&nbsp;Firebase" data-react-helmet="true"><meta property="og:description" content="How to implement Apple and Google authentication in Expo apps using Firebase" data-react-helmet="true"><meta property="og:url" content="https://capelski.github.io/blog/expo-social-sign-in" data-react-helmet="true"><meta property="og:image" content="https://capelski.github.io/images/blog/expo-social-sign-in/firebase-auth-providers.png" data-react-helmet="true"></head><body><noscript><h1>Carles Capellas</h1><p>JavaScript is required to load my page</p></noscript><div id="app-placeholder"><div class="app-container"><div class="article-container"><div class="section-viewport"><div class="section-content"><div class="article expo-social-sign-in" lang="en"><div class="article-info"><h2 class="article-title">Apple/Google authentication in Expo apps using&nbsp;Firebase</h2><div class="article-details"><span class="article-date">üìÖ 2021-02-20</span><span class="article-duration">üïê 8 mins</span><span class="article-language selected-language">üåé en</span></div></div><div class="article-body"><p>You are authenticating your Expo app users with email and password using Firebase. It works great but marketing funnels seem to indicate that users quit the app at the sign up screen. Looks like offering social sign options will help mitigate that problem, so says the marketing department, and you now want to add Apple sign-in and Google sign-in to your app. This is how to do it in February 2021!</p><p><i>To follow along with this story you need to meet this two requirements. You can check how to do so in <a href="/blog/react-native-firebase-auth">Email authentication in React Native apps using Firebase</a>:</i></p><ul><li><i>Have an existing Firebase project with Authentication enabled</i></li><li><i>Handle successful user authentication through Firebase <span class="article-inline-snippet">onAuthStateChanged</span> listener</i></li></ul><h3>Firebase limitations in React&nbsp;Native</h3><p>The Firebase Javascript SDK has an specific method called <span class="article-inline-snippet">signInWithPopup</span> to handle authentication providers' sign-in flow using OAuth. Relaying on the Firebase <a href="https://firebase.google.com/docs/auth/web/apple" target="_blank">Apple authentication documentation page</a> will instruct us to handle the sign-in flow in the following fashion:</p><iframe width="100%" frameborder="0" id="gist-1bb4b55d72cf38daef7a658cf4d81147" style="height: 150px;"></iframe><p>Using this approach in React Native apps will raise an exception however. This happens because the Firebase Javascript SDK is designed for web applications and the <span class="article-inline-snippet">signInWithPopup</span> method expects the app to run in a browser. Frog! We will need to find another way to do it.</p><div class="article-block-snippet">Error: This operation is not supported in the environment this application is running on. "location.protocol" must be http, https or chrome-extension and web storage must be enabled.</div><p>Fortunately for us we are using Expo üéâ and Expo has two modules designed for this specific purpose: <span class="article-inline-snippet">expo-google-app-auth</span> and <span class="article-inline-snippet">expo-apple-authentication</span>. Both modules authenticate the user against the corresponding provider and return a credential that can be used to authenticate the user in Firebase through the <span class="article-inline-snippet">signInWithCredential</span> method.</p><p><i>In fact Expo provides two modules to authenticate users against Google: <span class="article-inline-snippet">expo-google-app-auth</span> and <span class="article-inline-snippet">expo-google-sign-in</span>. They both achieve the same goal but the latter uses native Google authentication while the former uses a secure system web browser. At practice this means that <span class="article-inline-snippet">expo-google-sign-in</span> requires a bit more configuration and it doesn't work in the Expo Go client. Feel free to use the one you like better.</i></p><p>Having set the strategy it's just a matter of completing the necessary steps for each of the two modules. Let's go one by one.</p><h3>Sign in with&nbsp;Google</h3><p>Go ahead and install <span class="article-inline-snippet">expo-google-app-auth</span>. We will then use the straightforward <span class="article-inline-snippet">logInAsync</span> method to get the users' credentials. This method needs at least three parameters: <span class="article-inline-snippet">androidStandaloneAppClientId</span>, <span class="article-inline-snippet">iosStandaloneAppClientId</span>, and <span class="article-inline-snippet">scopes</span>.</p><p>The first two are OAuth 2.0 Client IDs that are automatically generated by Firebase when you activate the corresponding authentication providers while the third is a list of OAuth 2.0 scopes. Let's enable Google authentication provider and get our client IDs before moving into the code.</p><p>Navigate to <b>Authentication &gt; Sign-in method</b> and enable Google. After saving the changes the <i>Web client ID</i> and <i>Web client secret</i> fields will get populated but this is not the Client ID we are looking for.</p><div><img class="article-image" src="/images/blog/expo-social-sign-in/firebase-auth-providers.png" alt="Firebase authentication providers list"></div><div><img class="article-image" src="/images/blog/expo-social-sign-in/firebase-google-auth-provider.png" alt="Firebase Google authentication provider"></div><p>The client ID we need is generated after enabling the Google sign-in method and can be found in the corresponding Google Cloud Platform project. Go to <a href="https://console.cloud.google.com/" target="_blank">https://console.cloud.google.com/</a>, select the Firebase project (every Firebase project creates an associated GCP project) and navigate to <b>APIs &amp; Services &gt;Credentials</b>. There you will see a list of OAuth 2.0 Client IDs:</p><div><img class="article-image" src="/images/blog/expo-social-sign-in/gcp-oauth-client-ids.png" alt="Google Cloud Platform credentials dashboard"></div><p>Great! Now let's drop those client IDs into some code üí™ You might want to create environment variables for the client IDs instead of including them in the source code but I'm not doing so here for the sake of simplicity.</p><iframe width="100%" frameborder="0" id="gist-a47a64db2a2fe7d4ad3469655d98addf" style="height: 150px;"></iframe><p>The <span class="article-inline-snippet">logInAsync</span> call returns a promise with the result of the operation. If the result type equals The <span class="article-inline-snippet">success</span> we will then find the <span class="article-inline-snippet">idToken</span> and <span class="article-inline-snippet">accessToken</span> in the result, which we will use to authenticate the user in Firebase by creating a GoogleAuthProvider credential. If the result equals <span class="article-inline-snippet">cancel</span> means the user didn't complete the sign-in flow. Easy as 1,2,3!</p><p>Keep in mind that the code above will not work on the Expo Go client. You can either <b>create a new Internal testing release</b> on Google Play console and install the app on an Android device or <b>generate new OAuth 2.0 Client IDs</b> for testing purposes and pass them to <span class="article-inline-snippet">logInAsync</span> using the <span class="article-inline-snippet">androidClientId</span> and <span class="article-inline-snippet">iosClientId</span> parameters (in which case you will need 4 client IDs).</p><h3>Sign in with&nbsp;Apple</h3><p>Before starting configuring the Apple sign-in service I suggest you to read <a href="https://medium.com/@dansinger_68758/adding-sign-in-with-apple-to-a-managed-expo-app-using-firebase-authentication-ca331b4de05" target="_blank">this helpful story</a> from Dan Singer. There you will find some considerations that must be taken into account before adding the Apple sign-in into an Expo app, along with the explanation on how to do it. In this story I'll be extending his tutorial with more detail.</p><p><i>It comes as no surprise that Apple's sign-in is more complicated than Google's one and it can be tempting to skip it. Apple won't make so easy though. As stated in <a href="https://developer.apple.com/app-store/review/guidelines/#sign-in-with-apple" target="_blank">this section of the App Store Review Guidelines</a>, "apps that use social login services (e.g. Google sign-in) must also offer Sign in with Apple as an equivalent option". So let's make our best to get it working!</i></p><p>First we need to install the necessary modules: <span class="article-inline-snippet">expo-apple-authentication</span> and <span class="article-inline-snippet">expo-crypto</span>. We will use the <span class="article-inline-snippet">signInAsync</span> method from the <span class="article-inline-snippet">expo-apple-authentication</span> module to, just as we did before, get the user's credentials and then authenticate the user in Firebase using those credentials.</p><p>The difference this time is that <span class="article-inline-snippet">signInAsync</span> does not return an OAuth access token. As Dan Singer points in his story, we can get around this issue by providing a SHA256-hashed nonce to the <span class="article-inline-snippet">signInAsync</span> function and then pass the original nonce to Firebase's <span class="article-inline-snippet">signInWithCredential</span>. That's why we also need the <span class="article-inline-snippet">expo-crypto</span> module. Let's put it all together:</p><iframe width="100%" frameborder="0" id="gist-ea93abe5f49d1db77bab773ea83a894d" style="height: 150px;"></iframe><p>The <span class="article-inline-snippet">requestedScopes</span> parameter is a list of OAuth 2.0 scopes. Not that complicated after all! Next thing we need to care about is the UI. While Google let's you display their sign-in button the way you want Apple will require you to use a guideline approved button. In fact it's normal to get rejected because the sign in button doesn't meet the requirements.</p><div><img class="article-image with-footer" src="/images/blog/expo-social-sign-in/apple-sign-in-button-rejection.png" alt="App Store rejection e-mail due to non compliant Sign-in button"><p class="article-image-footer">App Store rejection e-mail due to non compliant Sign-in button</p></div><p>The simplest way to prevent the rejection is to use the "corporative" button Expo provides for us. Keep in mind that Apple sign-in only works on iOS devices so we need to check whether it's available or not before rendering the button. Expo gets us covered with the <span class="article-inline-snippet">isAvailableAsync</span> method:</p><iframe width="100%" frameborder="0" id="gist-17de06c5390b050620c548a9a5f233ce" style="height: 150px;"></iframe><p>Well! Having the code in place we can now move on to configuring the services. Let's start with Apple and we will tackle Firebase afterwards. Expo team did a great job documenting the necessary steps in the <a href="https://developer.apple.com/app-store/review/guidelines/#sign-in-with-apple" target="_blank"><span class="article-inline-snippet">expo-apple-authentication</span></a> page so make sure to take a look at it.</p><p>First add the <span class="article-inline-snippet">usesAppleSignIn</span> property to your <span class="article-inline-snippet">app.json</span> configuration file. Then head to <a href="https://developer.apple.com/" target="_blank">Apple Developer Portal</a> to do the following two things:</p><iframe width="100%" frameborder="0" id="gist-2615d8fc1ef19e0be681ae17c1f2872a" style="height: 150px;"></iframe><ul><li>Enable the Sign In with Apple capability for your App ID. Navigate to <b>Certificates, IDs &amp; Profiles &gt; Identifiers</b> and select your App ID. In the Capabilities list select <i>Sign In with Apple</i> and click <i>Configure</i>. Leave the <i>Enable as a primary App ID</i> option selected and provide the Return URL for your Firebase app (step 1 in the <a href="https://firebase.google.com/docs/auth/web/apple#configure-sign-in-with-apple" target="_blank">Firebase Apple Auth documentation page</a>)<div><img class="article-image" src="/images/blog/expo-social-sign-in/sign-in-with-apple-1.png" alt="Sign in with Apple App ID capability"></div><div><img class="article-image" src="/images/blog/expo-social-sign-in/sign-in-with-apple-2.png" alt="Sign in with Apple return url"></div></li><li>Enable the Sign In with Apple service in your app private key. If your app doesn't use a private key yet you will need to create a new one. Navigate to <b>Certificates, IDs &amp; Profiles &gt; Keys</b> and select your key. Click <i>Edit</i>, select the <i>Sign in with Apple</i> service and click <i>Configure</i>. In the list of Primary App IDs select the ID of your app.<div><img class="article-image" src="/images/blog/expo-social-sign-in/sign-in-with-apple-3.png" alt="Sign in with Apple Key service"></div><div><img class="article-image" src="/images/blog/expo-social-sign-in/sign-in-with-apple-4.png" alt="Sign in with Apple Primary App ID"></div></li></ul><p>We are done with Apple üíÉ Notice that we modified the App ID configuration and that will invalidate the app Provisioning Profile. Fortunately we can easily generate a new Profile as well as revoke the old one thanks to Expo by using a couple command line arguments next time we build the app:</p><div class="article-block-snippet">expo build:ios --clear-provisioning-profile --revoke-credentials</div><p>We are almost there! We only need to enable Apple authentication provider in Firebase and will have arrived to our destination: success. Head to the <a href="https://console.firebase.google.com/" target="_blank">Firebase console</a>, navigate to <b>Authentication &gt; Sign-in method</b> and enable Apple.</p><div><img class="article-image" src="/images/blog/expo-social-sign-in/firebase-apple-auth-provider-1.png" alt="Firebase Apple authentication provider"></div><p>In the <i>Services ID</i> field you will need to provide the ID of the <i>Sign In with Apple</i> service you've enabled in the app private key. You can find the Service ID in the Apple Developer Portal navigating to <b>Certificates, IDs &amp; Profiles &gt; Keys</b> and selecting your key. Next to the <i>Sign In with Apple</i> enabled service you will find the ID which looks like <i>{TeamID}.{Bundle ID}</i>.</p><div><img class="article-image" src="/images/blog/expo-social-sign-in/sign-in-with-apple-5.png" alt="Sign in with Apple Service ID"></div><p>The <i>OAuth code flow configuration</i> section is optional and I'm not sure it makes a difference to fill in the details or not. Given you only need your Apple Team ID and your app's private key I prefer to provide them but, again, I'm not sure it makes a difference. Feel free to skip this part and test your luck ü§û</p><div><img class="article-image" src="/images/blog/expo-social-sign-in/firebase-apple-auth-provider-2.png" alt="Firebase Apple authentication provider configuration"></div><p><i>You can download your private key (a&nbsp;.p8 format file) from the Apple Developer Portal but you can only do it once. If you let Expo handle the process back in the day then you probably won't be able to download the key. You can manually generate a new key from the Apple Developer Portal and then use <span class="article-inline-snippet">expo credentials:manager</span> to replace the private key your app uses.</i></p><p>Save the changes, head to the command line to generate a new&nbsp;.ipa in case you haven't done it above and that's all there is üéâ Wait for the new app version to be available in TestFlight and delight yourself with the wonders of the 21st century state-of-the-art authentication. Happy coding!</p><h3 class="posts-timeline">Posts timeline</h3><div class="article-links"><div class="previous-link"><span class="link-text"><a href="/blog/react-native-firebase-auth">‚¨ÖÔ∏è Previous</a><div class="title-preview">Email authentication in React Native apps using&nbsp;Firebase</div></span></div><div class="next-link"></div></div></div></div></div></div><div class="section-links"><a aria-current="page" class="link active" href="/blog">‚¨ÖÔ∏è Blog</a></div></div></div></div><script src="/main.js"></script></body></html>